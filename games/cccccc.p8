pico-8 cartridge // http://www.pico-8.com
version 27
__lua__
-- CCCCCC
-- bY aDAM RICHARDSON

player={
	x=0,
	y=0,
	w=8,
	h=8,
	sidx=0,
	sdir=1,
	sw=1,
	sh=1,
	anim_t=0,
	flipping=false,
	anim_time=0.08}

grnd_s=3
exit_s=16

level=0
start_grav=2
gravity=2
bg_c=3
map_bricks={}
-->8

function anim()
	if(player.anim_t+player.anim_time<t()) then
		player.anim_t=t()
		player.sidx+=player.sw*player.sdir
		if player.sidx>player.sw*2 then
			player.sidx=player.sw
			player.sdir*=-1
		end
		if player.sidx<0 then
			player.sidx=player.sw
			player.sdir*=-1
		end
	end
end

function box_collide(r1,r2)
	return r1.x<(r2.x+r2.w) and
		(r1.x+r1.w)>r2.x and
		r1.y<(r2.y+r2.h) and
		(r1.y+r1.h)>r2.y
end

function physics()
	local x=player.x
	local y=(player.y+gravity)
	
	if gravity>0 then
		y+=(8-gravity)
	end
	local clear=true
	for i=0,1 do
		for j=0,1 do
			local x=player.x+(i*player.w)
			local y=player.y+(j*player.h)
			if mget(x,y)==grnd_s then
				clear=false
				break
			end
		end
	end
	
	if clear then
		player.flipping=true
		move_player(
			player.x,
			player.y+gravity)
		if player.y>128 or player.y<-8 then
			-- respawn
			player.x=0
			player.y=0
			gravity=start_grav
		end
	else
		player.flipping=false
	end
end

function check_exit()
--	local xy=mapxy_l(player.x,player.y)
--	return mget(xy.x,xy.y)==exit_s	
end

function level_start()
	player.x=0
	player.y=0
	player.anim_t=0
	cls(bg_c)
	map(level*16,0,0,0)
	map_bricks={}
	for i=0,15 do
		for j=0,15 do
			if mget(i,j)==grnd_s then
				add(map_bricks,{
					x=i*8,
					y=j*8,
					w=8,
					h=8
				})
			end
		end
	end
end

function clear_rect(r)
	rectfill(
		r.x,
		r.y,
		r.x+r.w,
		r.y+r.h,
		bg_c)
		map(level*16,0,0,0)
end

function move_player(x,y)
	clear_rect({
		x=player.x,
		y=player.y,
		w=player.sw*8,
		h=player.sh*8,
	})
	player.x=x
	player.y=y
	spr(
		player.sidx,
		player.x,
		player.y,
		player.sw,
		player.sh,
		false,
		gravity<0)
end

function check_player_move(x,y)
	return mget(x/8,y/8)!=grnd_s
end
-->8
function _init()
	level_start()
end

function _update60()
	if btn(⬅️) or btn(➡️) then
		if btn(➡️) then
			local x=player.x+1
			x=min(x,120)
			if check_player_move(x+8,player.y) then
				move_player(x,player.y)
			end
		else
			local x=player.x-1
			x=max(x,0)
			if check_player_move(x,player.y) then
				move_player(x,player.y)
			end
		end
		anim()
	else
		player.sidx=1
	end
	
	if btnp(❎) and not player.flipping then
		gravity*=-1
	end
	physics()
	if check_exit() then
		printh("you did it")
		level+=1
		level_start()
	end
end

function _draw()
--	cls(3)
--	map(level*16,0,0,0)

end
__gfx__
00077000000770000007700004445440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000770000007700045454444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777777777777754444454000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
70077007700770077007700745444545000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000770000007700054454444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00777700007777000077770044444544000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700770007007000770070045445445000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07700000077007700000077004454440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0cccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0cccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0cccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0c6cccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0cccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0cccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0cccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030000000000030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000030300000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000303030000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000030000000000000000000000000000000300000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000003030000000000000003000300000000000000030303000000030000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000300000000000000000000000300000003000000000003030303000003000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000300000300000000000000001000030000000000030000000303030303000300000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030303030303030303030303030303000000000000000303030303030303030000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
